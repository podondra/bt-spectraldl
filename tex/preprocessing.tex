\chap Preprocessing

This chapter describes all the action taken on the data from Ondřejov
dataset before processing then through a neural network.

\sec Knowledge Transfer

Ondřejov and \glref{LAMOST} spectrographs have different parameters
(as described in sections \ref[ondrejov-archive] and
\ref[lamost-archive]).
Thus, spectra from the two archive different.
Concretely, spectra from Ondřejov archive has much more details than
spectra from \glref{LAMOST}spectrograph
and spectra in Ondřejov archive are stored in air wavelengths
but \glref{LAMOST} store spectra in vacuum wavelengths.

This thesis is concerned with classifying \glref{LAMOST} data using
data from Ondřejov.
It aims to extract as much knowledge as possible from Ondřejov data
and apply it to classification of \glref{LAMOST} archive.
Transfer learning and domain adaptation
(described in chapter \ref[transfer-learning])
are study area of machine learning which aim to offer methods
for dealing with these problems.

The following sections introduce methods
that were applied to Ondřejov data.
These methods make the two domains more similar and so
they deal with differences between the archives mentioned above.

\secc Wavelength Conversion

Ondřejov and \glref{LAMOST} archives store wavelengths in air and vacuum
wavelength respectively.
When spectra of same object from the two archives are plotted on each
other they are a bit shifted (see top plot in figure \ref[air2vacuum]).
Therefore, Ondřejov spectra are converted to vacuum wavelengths
according to formulas provided in \cite[air2vacuum]:

$$ \lambda_{v} = n \lambda_{a} \eqmark $$

$$
n = 1 + 8.34254 \cdot 10^{-5} +
    {2.406147 \cdot 10^{-2} \over (130 - s^2)} +
    {1.5998 \cdot 10^{-4} \over (38.9 - s^2)}
\eqmark
$$

$$ s = {10^4 \over \lambda_{a}} \eqmark $$

where $\lambda_{v}$ is vacuum wavelength and $\lambda_{a}$ is
corresponding air wavelength.

The resulting Ondřejov spectrum after air to vacuum conversion
is plotted in bottom plot in figure \ref[air2vacuum].

\midinsert \clabel[air2vacuum]{Air to vacuum conversion}
\picw=15cm \cinspic img/air2vacuum.png
\caption/f Spectrum of object HIP47636 from Ondřejov archive before
and after conversion of air to vacuum wavelengths in comparison with
spectrum of the same object from \glref{LAMOST} archive.
\endinsert

\secc Gaussian Blur

According to \cite[szeliski2010] Gaussian filter smooths away high-frequency
detail of images.
Spectrum can be seen as one dimensional image.
Correctly parameterized Gaussian blur applied to Ondřejov spectrum
would reduce the amount of detail
and thus make it more similar to spectrum from \glref{LAMOST} archive.

The equation of a one dimensional Gaussian function:

$$ G(x) = {1 \over \sqrt{2 \pi \sigma^2}} e^{-{x^2 \over 2 \sigma^2}} \eqmark $$

where $\sigma$ is standard deviation in pixels.

This work uses convolution implementation from Python package astropy
\cite[astropy] in version 1.3.1.
Standard deviation of value 7 was chosen after visualizing results of
convolutions.

\begtt
from astropy.convolution import Gaussian1DKernel, convolve

gauss_kernel = Gaussian1DKernel(stddev=7)
smoothed_fluxes = convolve(fluxes, gauss_kernel)
\endtt

\midinsert \clabel[gaussian-blur-plot]{Gaussian blur}
\picw=15cm \cinspic img/gaussian-blur.png
\caption/f TODO
\endinsert

\sec Regridding

To train, validate and test deep neural network
two dimensional dataset matrices needs to be created.
In a matrix each row is a spectrum sample
and each column represents flux in certain wavelength.
That means that all spectra need to be regrided to same wavelengths.

The wavelengths range is given by Ondřejov dataset from 6519 to 6732
(minimum is rounded up and maximum is rounded down to nearest integer value).
Ondřejov spectra in this range has 829, 830, 831, or 922, 923 measured fluxes
according to this thesis's experiments.
This variance is caused by change of spectrograph in Ondřejov observatory
(see section \ref[ondrejov-archive])
and the small deviation by the cut of spectrum into the range.
LAMOST spectra has 140 measurements in this range
inferred from 22 cross-matched spectra.

Because Ondřejov spectra are moved to \glref{LAMOST} resolution,
after air to vacuum conversion and convolution,
spectra are regrided uniformly to 140 points in range 6519 to 6732.
To do regridding linear interpolation is used.
Here is NumPy 1.12.1 \cite[numpy] code carrying out this operation:

\begtt
import numpy as np

new_wavelengths = np.linspace(6519, 6732, num=140)
new_fluxes = np.interp(new_wavelengths, old_wavelengths, old_fluxes)
\endtt

where {\tt old\_wavelengths} variable holds old wavelengths
and {\tt old\_fluxes} variable holds corresponding fluxes of a spectrum.

\sec Dimensionality Reduction

TODO

\secc PCA

Principal Component Analysis.

\midinsert \clabel[pca-plot]{PCA}
\picw=15cm \cinspic img/pca.png
\caption/f TODO
\endinsert

\secc t-SNE

Other popular method of dimensionality reduction is t-Distributed Stochastic
Neighbor Embedding. \glref{t-SNE} is TODO.
\cite[tsne]

\midinsert \clabel[tsne-plot]{TODO}
\picw=15cm \cinspic img/tsne.png
\caption/f TODO
\endinsert

\sec Dataset Split

This section shows how the Ondřejov dataset is split into
training, validation and test set.
These sets are required for training, tuning and evaluating any neural network.
All split are done as stratified sampling so that the distribution of
samples' number in a class is kept across sets.

Test set on which the neural network is evaluated contains 10\% of all data.
Validation set which serves for hyperparameter and architecture optimization
is 20\% of remaining data.
Training set is composed from the rest of data
and its purpose is for training the network's weights contains 80\% of all data.
Exact numbers of spectra in each set is in table \ref[dataset-split-table].

\midinsert \clabel[dataset-split-table]{Dataset split table}
\ctable{lrrr}{
    \hfil set  & emission & absorption & double-peak \hfil \crl \tskip4pt
    train      &     3817 &       4393 & 1104 \cr
    validation &      954 &       1099 &  276 \cr
    test       &      530 &        611 &  153 \cr
}
\caption/t Exact number of samples in train, validation and test set
divided according to emission, absorption and double-peak classes.
\endinsert

\sec SMOTE Balancing

\glref{SMOTE} is shortcut for Synthetic Minority Over-Sampling Technique.
\cite[smote]
